# 体系结构Lab4实验报告

### PB16050567	陈炜

## 实验目标

1、实现分支预测BTB

2、实现分支预测BHT

3、统计分支收益和分支代价。

## 实验环境和工具

实验环境：Vivado2017.4

实验工具：Vivado自带编辑器和波形仿真工具

## 实验内容和过程

#### 阶段一：BTB

##### Judge模块：

​	我将判断分支预测是否失败的功能从BTB中独立了出来，设为Judge模块。

​	Judge模块的输入输出如下：

```verilog
input rst,
    input [31:0] EXpc,
    input [31:0] IDpc,      //ID段寄存器的PC，用于判断预测和实际是否相符
    input [31:0] BrNPC,      //计算出来的跳转地址
    input BranchE,
    input [2:0]BranchTypeE,

    output reg [1:0] BTBflush,          //10的时候，指示BTB更新设置为有效，01的时候，设空cahce，EXpc和Aluout不通过本模块传递,00表示不用改变
output reg [1:0] PredictMiss        //通知NpcGenerator和Hazzard模块
```

​	其中

​	Judge模块主要使用BranchE,BranchTypeE,BrNPC,ID段PC，和EX段PC进行判断。

​	如果BranchE为真，表明此次分支真实情况是命中，此时需要判断ID段寄存器中的PC(预测出来的值)是否和BrNPC相同，如果相同，说明预测正确，否则错误，需要更新BTB中和当前PC(EX段寄存器中PC值)对应的BTBcache中的值为命中的PC值。

​	如果BranchE为假，并且BranchTypeE为真，说明这是一条不命中的分支指令，此时需要判断EX段寄存器中的PC+4是否等于ID段寄存器中的PC，如果相等，说明预测正确，否则错误，需要更新BTB中和当前PC(EX段寄存器中PC值)对应的BTBcache状态为Invalid。

​	在以上两种情况中，如果遇到预测错误的情况，需要通知NPC_Genarator模块去对应的位置取下一个PC值，还要通知Hazzard模块做相应的处理。

​	如果BranchE和BranchTypeE均为假，说明这不是一条分支指令，无需处理。

​	Judge的判断代码如下：

```verilog

always@(*)
begin
    if(rst)
    begin
        BTBflush<=0;
        PredictMiss<=0;
    end
    else
    begin
        if(BranchE)     //实际命中了
        begin
            if(IDpc==BrNPC)     //预测也命中了
            begin
                BTBflush<=0;
                PredictMiss<=0;
            end
            else 
            begin
                BTBflush<=2'b10;        //
                PredictMiss<=2'b10;
            end
        end
        else if(BranchTypeE!=0)     //实际没命中
        begin
            if(EXpc+3'b100==IDpc)
            begin
                BTBflush<=0;
                PredictMiss<=0;
            end
            else
            begin
                BTBflush<=2'b01;
                PredictMiss<=2'b01;
            end
        end
        else        //根本不是跳转指令
        begin
            BTBflush<=0;
            PredictMiss<=0;
        end
    end
end
```

##### BTB模块：

​	BTB模块是一个由16路组成的直接映射cache，cache的内容包括，用于比较的tag，用于预测的PC值，用于标识当前块是否有效的标识位。

​	BTB的输入输出如下：

```verilog
input rst,                  //用于初始化
    input [1:0] BTBflush,           //在纯BTB中用于判断flush与否
    input [31:0] BrNPC,        //新的预测PC，既是跳转PC,BrNPC
    input [31:0] EXpc,     //改变了预测值的PC,EXpc
    input [31:0] CurrentPC,     //用于提取预测值

    output reg [31:0] PrePC,        //预测值
    output reg BTBhit               //BTBcache中是否命中
```

​	BTB模块中有两个段控制逻辑：

​	1、更新cache内容：

​	根据从Judge中接受的BTBflush信号来在预测失败的时候更新cache的内容。

​	如果预测不命中而实际命中，更新EXpc对应的

cache块的内容，将其置为valid。

​	如果预测命中而实际不明中，将EXpc对应cache块的标志位设为0.

```verilog
 if(BTBflush==2'b10)     //需要从无效变为有效    
        begin
            valid[updateAddr]<=1'b1;
            Pretag[updateAddr]<=updateTag;
            PreCache[updateAddr]<=BrNPC;
        end     //update
        else if(BTBflush==2'b01)        //需要从有效变为无效
            valid[updateAddr]=0;        
```

​	2、为NPC_Genarator提供预测PC值

​	

​	